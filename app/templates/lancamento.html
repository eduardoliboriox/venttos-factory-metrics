{% extends "base.html" %}
{% block title %}Lan√ßamento de Absente√≠smo{% endblock %}
{% block page_title %}Venttos - Factory Metrics - Lan√ßamento de Absente√≠smo{% endblock %}

{% block content %}
<form id="formLancamento"
      method="post"
      action="{{ url_for('api.api_criar_lancamento') }}">

  <!-- üî¥ CAMPO OCULTO PARA ENVIAR OS CARGOS -->
  <input type="hidden" name="cargos" id="cargosJson">

  <div class="row g-3">

    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" name="data" class="form-control" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Filial</label>
      <select name="filial" class="form-select" required>
        <option value="VTE">VTE</option>
        <option value="VTT">VTT</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Setor</label>
      <select name="setor" class="form-select" required>
        <option value="IM">IM</option>
        <option value="PA">PA</option>
        <option value="SMT">SMT</option>
        <option value="PTH">PTH</option>
      </select>
    </div>

      <div class="col-md-3">
        <label class="form-label">Linha</label>
        <select name="linha" id="linhaSelect" class="form-select" required>
          <option value="">Selecione o setor primeiro</option>
        </select>
      </div>


    <div class="col-md-3">
      <label class="form-label">Turno</label>
      <select name="turno" class="form-select" required>
        <option value="1T">1¬∫ Turno</option>
        <option value="2T">2¬∫ Turno</option>
        <option value="3T">3¬∫ Turno</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Padr√£o</label>
      <input type="number" name="hc_padrao" class="form-control" required
             oninput="atualizarHCReal()">
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Real</label>
      <input type="number" name="hc_real" class="form-control" readonly>
    </div>

    <div class="col-md-4">
      <label class="form-label">F√©rias</label>
      <input type="number" name="ferias" class="form-control">
    </div>

    <hr>

    <h6 class="fw-bold mt-3">Absente√≠smo por Cargo</h6>

    <div class="row g-3">

      <div class="col-md-6">
        <label class="form-label">Cargo</label>
        <select id="cargo" class="form-select">
          <option value="">Selecione</option>

          <optgroup label="√Årea T√©cnica">
            {% for c in cargos_tecnica %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </optgroup>

          <optgroup label="Produ√ß√£o">
            {% for c in cargos_producao %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </optgroup>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Qtd</label>
        <input type="number" id="qtd" class="form-control" min="1">
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button type="button" class="btn btn-secondary w-100" onclick="addCargo()">
          Adicionar
        </button>
      </div>

    </div>

    <ul id="listaCargos" class="list-group mt-3"></ul>

    <div class="col-12">
      <button type="submit" class="btn btn-primary w-100">
        Salvar Lan√ßamento
      </button>
    </div>

  </div>
</form>

<!-- Mensagem de resultado -->
<div id="msgLancamento" class="mt-3"></div>

{% endblock %}

{% block scripts %}

<script>
let cargos = [];

function addCargo() {
    const cargoSelect = document.getElementById("cargo");
    const qtdInput = document.getElementById("qtd");

    const cargoId = cargoSelect.value;
    const cargoNome = cargoSelect.options[cargoSelect.selectedIndex].text;
    const qtd = parseInt(qtdInput.value);

    if (!cargoId || !qtd || qtd <= 0) {
        alert("Selecione um cargo e informe a quantidade.");
        return;
    }

    cargos.push({
        cargo_id: parseInt(cargoId),
        quantidade: qtd
    });

    document.getElementById("listaCargos").innerHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            ${cargoNome}
            <span class="badge bg-primary">${qtd}</span>
        </li>
    `;

    document.getElementById("cargosJson").value = JSON.stringify(cargos);

    atualizarHCReal();

    cargoSelect.value = "";
    qtdInput.value = "";
}
</script>

<script>
document.getElementById("formLancamento").addEventListener("submit", async function(e){
    e.preventDefault();

    document.getElementById("cargosJson").value = JSON.stringify(cargos);

    const formData = new FormData(this);

    try {
        const resp = await fetch(this.action, {
            method: "POST",
            body: formData
        });

        const data = await resp.json();
        const msgDiv = document.getElementById("msgLancamento");

        if(data.sucesso){
            msgDiv.innerHTML = `
                <div class="alert alert-success">
                    Lan√ßamento salvo com sucesso! Absente√≠smo calculado:
                    <strong>${data.absenteismo}%</strong>
                </div>
            `;
            this.reset();
            cargos = [];
            document.getElementById("listaCargos").innerHTML = "";
        } else {
            msgDiv.innerHTML = `
                <div class="alert alert-danger">
                    Ocorreu um erro ao salvar o lan√ßamento.
                </div>
            `;
        }
    } catch(err){
        msgDiv.innerHTML = `
            <div class="alert alert-danger">
                Erro de conex√£o. Tente novamente.
            </div>
        `;
        console.error(err);
    }
});
</script>

<script>
function atualizarHCReal(){
  const hcPadrao = parseInt(document.querySelector("[name='hc_padrao']").value || 0);
  const totalFaltas = cargos.reduce((s, c) => s + c.quantidade, 0);
  document.querySelector("[name='hc_real']").value = Math.max(hcPadrao - totalFaltas, 0);
}
</script>

<script>
const linhasPorSetor = {
  IM: ["IM-01","IM-02","IM-03","IM-04","IM-05","IM-06"],
  PA: ["IP-COM","PA-01","PA-03","PA-04","PA-07","PA-08","PA-09","PA-13","WIFI"],
  PTH: ["ADE-01","AXI-01","AXI-02","AXI-03","JUM-01","JUM-02","RAD-01","RAD-02","RAD-03","ROU-01","ROU-02","ROU-03"],
  SMT: ["SMT-01","SMT-02","SMT-03","SMT-04","SMT-05","SMT-06","SMT-07","SMT-08","SMT-09"],
  VTT: ["PA-12","PA-16","PA-17","PA-18","PA-19","PA-20"]
};

const setorSelect = document.querySelector("select[name='setor']");
const linhaSelect = document.getElementById("linhaSelect");

setorSelect.addEventListener("change", () => {
  const setor = setorSelect.value;

  linhaSelect.innerHTML = "";

  if (!linhasPorSetor[setor]) {
    linhaSelect.innerHTML = `<option value="">Selecione o setor primeiro</option>`;
    return;
  }

  linhaSelect.innerHTML = `<option value="">Selecione</option>`;

  linhasPorSetor[setor].forEach(linha => {
    const opt = document.createElement("option");
    opt.value = linha;
    opt.textContent = linha;
    linhaSelect.appendChild(opt);
  });
});
</script>


{% endblock %}
